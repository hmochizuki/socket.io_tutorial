<!DOCTYPE html>
<html>
  <link rel="stylesheet" type="text/css" href="style.css" />
  <head>
    <title>Socket.IO chat</title>
  </head>
  <body>
    <dialog id="nickname-doalog">
      <form id="nickname-form" method="doalog">
        <p>
          Your nickname:
          <input
            id="nickname-form__input"
            class="nickname-form__input"
            autocomplete="off"
            placeholder="anonymous"
            maxlength="15"
            minlength="1"
          />
        </p>
        <button id="nickname-form__button" class="nickname-form__button">
          Send
        </button>
      </form>
    </dialog>
    <header id="header">
      <p id="header__nickname" class="header__nickname">anonymous</p>
    </header>
    <ul id="info" class="info"></ul>
    <ul id="messages" class="messages"></ul>
    <form id="message-form" class="message-form" action="">
      <input
        id="message-form__input"
        class="message-form__input"
        autocomplete="off"
      /><button class="message-form__button">Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-form__input");
      const nicknameForm = document.getElementById("nickname-form");
      const nicknameInput = document.getElementById("nickname-form__input");
      const headerNickname = document.getElementById("header__nickname");
      const info = document.getElementById("info");
      const nicknameDialog = document.getElementById("nickname-doalog");
      if (typeof nicknameDialog.showModal === "function") {
        nicknameDialog.showModal();
      }

      const addMessage = ({ msg, nickname }) => {
        const item = document.createElement("li");
        const name = nickname || "anonymous";
        item.textContent = `${nickname}: ${msg}`;
        item.className = "messages__item";
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      };

      messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (messageInput.value) {
          const msg = messageInput.value;
          const nickname = nicknameInput.value;
          socket.emit("chat message", { msg, nickname });
          messageInput.value = "";
          addMessage({ msg, nickname });
        }
      });

      messageInput.addEventListener(
        "input",
        throttle(() => socket.emit("typing", nicknameInput.value), 5000)
      );

      nicknameForm.addEventListener("submit", function (e) {
        e.preventDefault();
        nicknameDialog.close();
        headerNickname.textContent = nicknameInput.value;
        if (nicknameInput.value) {
          socket.emit("nickname", nicknameInput.value);
        }
      });

      socket.on("chat message", addMessage);

      const showInfo = (msg) => {
        const item = document.createElement("li");
        item.className = "info__item";
        item.textContent = msg;
        info.appendChild(item);
        setTimeout(() => {
          info.removeChild(item);
        }, 5000);
      };
      socket.on("info", showInfo);

      function throttle (cb, interval) {
        let pre = new Date();
        return () => {
          const now = new Date();
          if (now - pre > interval) {
            cb();
            pre = now;
          }
        };
      };
    </script>
  </body>
</html>
