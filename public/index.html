<!DOCTYPE html>
<html>
  <link rel="stylesheet" type="text/css" href="style.css" />
  <head>
    <title>Socket.IO chat</title>
  </head>
  <body>
    <dialog id="nickname-doalog">
      <form id="nickname-form" method="doalog">
        <p>Your nickname:
          <input
            id="nickname-form__input"
            class="nickname-form__input"
            autocomplete="off"
            placeholder="anonymous"
            maxlength="15"
            minlength="1"
          />
        </p>
        <button id="nickname-form__button" class="nickname-form__button">Send</button>
      </form>
    </dialog>
    <header id="header">
      <p id="header__nickname" class="header__nickname">anonymous</p>
    </header>
    <ul id="info" class="info"></ul>
    <ul id="messages" class="messages"></ul>
    <form id="message-form" class="message-form" action="">
      <input
        id="message-form__input"
        class="message-form__input"
        autocomplete="off"
      /><button class="message-form__button">Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      var messageForm = document.getElementById("message-form");
      var messageInput = document.getElementById("message-form__input");
      var nicknameForm = document.getElementById("nickname-form");
      var nicknameInput = document.getElementById("nickname-form__input");
      var headerNickname = document.getElementById("header__nickname")
      var info = document.getElementById("info");
      var nicknameDialog = document.getElementById('nickname-doalog');
      if (typeof nicknameDialog.showModal === "function") {
        nicknameDialog.showModal();
      }

      function addMessage({ msg, nickname }) {
        var item = document.createElement("li");
        const name = nickname || "anonymous";
        item.textContent = `${nickname}: ${msg}`;
        item.className = "messages__item";
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      }

      messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (messageInput.value) {
          var msg = messageInput.value;
          var nickname = nicknameInput.value;
          socket.emit("chat message", { msg, nickname });
          messageInput.value = "";
          addMessage({ msg, nickname });
        }
      });

      messageInput.addEventListener("input", function () {
        socket.emit("typing", nicknameInput.value);
      });

      nicknameForm.addEventListener("submit", function (e) {
        e.preventDefault();
        nicknameDialog.close();
        headerNickname.textContent = nicknameInput.value
        if (nicknameInput.value) {
          socket.emit("nickname", nicknameInput.value);
        }
      });

      socket.on("chat message", addMessage);

      function showInfo(msg) {
        var item = document.createElement("li");
        item.className = "info__item";
        item.textContent = msg;
        info.appendChild(item);
        setTimeout(() => {
          info.removeChild(item);
        }, 5000);
      }
      socket.on("info", showInfo);
    </script>
  </body>
</html>
