<!DOCTYPE html>
<html>
  <link rel="stylesheet" type="text/css" href="style.css" />
  <head>
    <title>Socket.IO chat</title>
  </head>
  <body>
    <header id="header">
      <span id="header__nickname" class="header__nickname">anonymous</span>
    </header>
    <nav id="nav">
      <section id="nav__users">
        <h3 id="nav__users--title" class="nav__users--title">Logined Users</h3>
        <ui id="nav__users--list" class="nav__users--list"></ui>
      </section>
    </nav>
    <main>
      <dialog id="nickname-doalog">
        <form id="nickname-form" method="doalog">
          <p>
            Your nickname:
            <input
              id="nickname-form__input"
              class="nickname-form__input"
              autocomplete="off"
              placeholder="anonymous"
              maxlength="15"
              minlength="1"
            />
          </p>
          <button id="nickname-form__button" class="nickname-form__button">
            Send
          </button>
        </form>
      </dialog>
      <section id="info">
        <ul id="info__list" class="info__list"></ul>
      </section>
      <ul id="messages" class="messages"></ul>
      <form id="message-form" class="message-form" action="">
        <span id="typing" class="typing"></span>
        <input
          id="message-form__input"
          class="message-form__input"
          autocomplete="off"
        /><button class="message-form__button">Send</button>
      </form>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-form__input");
      const nicknameForm = document.getElementById("nickname-form");
      const nicknameInput = document.getElementById("nickname-form__input");
      const headerNickname = document.getElementById("header__nickname");
      const info = document.getElementById("info__list");
      const nicknameDialog = document.getElementById("nickname-doalog");
      if (typeof nicknameDialog.showModal === "function") {
        nicknameDialog.showModal();
      }

      const addMessage = ({ msg, nickname }) => {
        const item = document.createElement("li");
        const name = nickname || "anonymous";
        item.textContent = `${nickname}: ${msg}`;
        item.className = "messages__item";
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      };

      messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (messageInput.value) {
          const msg = messageInput.value;
          const nickname = nicknameInput.value;
          socket.emit("chat message", { msg, nickname });
          messageInput.value = "";
          addMessage({ msg, nickname });
        }
      });

      messageInput.addEventListener(
        "input",
        throttle(() => socket.emit("typing", nicknameInput.value), 5000)
      );

      nicknameForm.addEventListener("submit", function (e) {
        e.preventDefault();
        nicknameDialog.close();
        headerNickname.textContent = nicknameInput.value;
        if (nicknameInput.value) {
          socket.emit("nickname", nicknameInput.value);
          socket.emit("join", nicknameInput.value);
        }
      });

      socket.on("chat message", addMessage);

      socket.on("users", (users) => {
        const userList = document.getElementById("nav__users--list");
        users.forEach((user) => {
          const item = document.createElement("li");
          item.textContent = user.nickname;
          item.id = `nav__users--item-${user.id}`;
          userList.appendChild(item);
        });
      });
      socket.on("join", (user) => {
        const userList = document.getElementById("nav__users--list");
        const item = document.createElement("li");
        item.textContent = user.nickname;
        item.id = `nav__users--item-${user.id}`;
        userList.appendChild(item);
      });
      socket.on("leave", (user) => {
        const item = document.getElementById(`nav__users--item-${user.id}`);
        item.remove();
      });

      const showInfo = (msg) => {
        const item = document.createElement("li");
        item.textContent = msg;
        info.appendChild(item);
        setTimeout(() => {
          info.removeChild(item);
        }, 5000);
      };
      socket.on("info", showInfo);

      const onTyping = function () {
        let typingUsers = []
        return (user) => {
          const element = document.getElementById("typing");
          typingUsers.push(user),
          setTimeout(() => {
            typingUsers.pop()
            element.textContent = createTypingMessage(typingUsers)
          }, 5000)
          element.textContent = createTypingMessage(typingUsers)
        }
      }()
      socket.on("typing", onTyping);

      function createTypingMessage (users) {
        if(users.length) return `${users.map((u) => u.nickname).join(", ")} is typing...`
        return ""
      }

      function throttle(cb, interval) {
        let pre = new Date();
        return () => {
          const now = new Date();
          if (now - pre > interval) {
            cb();
            pre = now;
          }
        };
      }
    </script>
  </body>
</html>
